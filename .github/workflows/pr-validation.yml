name: ğŸ” PR Validation

# ============================================================================
# Validaciones en Pull Requests
# Ejecuta checks de calidad sin desplegar
# ============================================================================
on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  # ========================================================================
  # AnÃ¡lisis de cambios
  # ========================================================================
  changed-files:
    name: ğŸ“Š Analyze Changed Files
    runs-on: ubuntu-latest
    
    outputs:
      src: ${{ steps.changed-files.outputs.src_any_changed }}
      prisma: ${{ steps.changed-files.outputs.prisma_any_changed }}
      docker: ${{ steps.changed-files.outputs.docker_any_changed }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            src/**
            prisma/**
            Dockerfile
            docker-compose.yml
          files_yaml: |
            src:
              - 'src/**'
            prisma:
              - 'prisma/**'
            docker:
              - 'Dockerfile'
              - 'docker-compose.yml'

  # ========================================================================
  # ValidaciÃ³n de cÃ³digo
  # ========================================================================
  validate:
    name: âœ… Code Validation
    runs-on: ubuntu-latest
    needs: changed-files
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ¯ Run ESLint
        if: needs.changed-files.outputs.src == 'true'
        run: npm run lint -- --max-warnings=0

      - name: ğŸ” TypeScript check
        if: needs.changed-files.outputs.src == 'true'
        run: npx tsc --noEmit

      - name: ğŸ“¦ Prisma validate
        if: needs.changed-files.outputs.prisma == 'true'
        run: npx prisma validate
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost/chat_psy_test"

  # ========================================================================
  # Security scanning
  # ========================================================================
  security:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Dependabot
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: HEAD
          extra_args: --debug --only-verified

  # ========================================================================
  # Performance & Size checks
  # ========================================================================
  size-check:
    name: ğŸ“¦ Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build application
        run: npm run build
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost/chat_psy_test"
          NEXTAUTH_SECRET: "test-secret-key-1234567890abcdefghijklmnopqrstuv"
          NEXTAUTH_URL: "http://localhost:3000"
          ENCRYPTION_KEY: "test-encryption-key-1234567890abcdefghijklmnopqrst"

      - name: ğŸ“Š Check bundle size
        run: |
          SIZE=$(($(du -sb .next | cut -f1) / 1024 / 1024))
          MAX_SIZE=500
          echo "ğŸ“¦ Bundle size: ${SIZE}MB"
          if [ $SIZE -gt $MAX_SIZE ]; then
            echo "âš ï¸  Bundle exceeds ${MAX_SIZE}MB threshold"
            exit 1
          fi

  # ========================================================================
  # Docker validation
  # ========================================================================
  docker-validation:
    name: ğŸ³ Docker Validation
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.docker == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ” Validate Dockerfile
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile
        continue-on-error: true

      - name: ğŸ³ Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: chat-psy:pr-${{ github.event.number }}
          cache-from: type=gha

  # ========================================================================
  # Resume final
  # ========================================================================
  summary:
    name: ğŸ“‹ Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [validate, security, size-check, docker-validation]
    
    steps:
      - name: ğŸ“Š Check results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PR Validation Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Validate:           ${{ needs.validate.result }}"
          echo "Security:           ${{ needs.security.result }}"
          echo "Size Check:         ${{ needs.size-check.result }}"
          echo "Docker Validation:  ${{ needs.docker-validation.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âš ï¸  Mark as failed if any job failed
        if: >
          needs.validate.result == 'failure' ||
          needs.security.result == 'failure' ||
          needs.size-check.result == 'failure'
        run: |
          echo "âŒ PR Validation failed"
          exit 1
